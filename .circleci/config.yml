version: 2.1
orbs:
  node: circleci/node@4.1.0
  pulumi: pulumi/pulumi@2.0.0
  slack: circleci/slack@4.0.1

jobs:
  build-website:
    executor:
      name: node/default
      tag: "14.13.1"
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn
      - run:
          name: Build website
          command: yarn build:www.hlidacshopu.cz
      - persist_to_workspace:
          root: .
          paths: [public]
      - slack/notify:
          channel: ntf-hlidac-shopu
          event: fail
          template: basic_fail_1

  build-web-extension:
    executor:
      name: node/default
      tag: "14.13.1"
    steps:
      - checkout
      - run:
          name: Install CLI tools
          command: |
            sudo apt-get update
            sudo apt-get install rename
      - node/install-packages:
          pkg-manager: yarn
      - run:
          name: Lint web extension
          command: |
            mkdir -p results
            yarn lint:extension
            yarn lint:extension -o json > results/lint.json
      - run:
          name: Build web extensions
          command: |
            yarn build:chrome
            yarn build:firefox
      - store_artifacts:
          path: ./results
      - store_artifacts:
          path: ./dist
      - slack/notify:
          channel: ntf-hlidac-shopu
          event: fail
          template: basic_fail_1

  provision:
    executor:
      name: node/default
      tag: "14.13.1"
    environment:
      AWS_STS_REGIONAL_ENDPOINTS: regional
    steps:
      - checkout
      - pulumi/login:
          cloud-url: s3://pulumi.hlidacshopu.cz
      - node/install-packages:
          pkg-manager: yarn
      - pulumi/update:
          stack: hlidac-shopu-prod
          skip-preview: true
      - slack/notify:
          channel: ntf-hlidac-shopu
          event: fail
          template: basic_fail_1

  preview-provision:
    executor:
      name: node/default
      tag: "14.13.1"
    steps:
      - checkout
      - pulumi/login:
          cloud-url: s3://pulumi.hlidacshopu.cz
      - node/install-packages:
          pkg-manager: yarn
      - pulumi/preview:
          stack: hlidac-shopu-prod
      - slack/notify:
          channel: ntf-hlidac-shopu
          event: fail
          template: basic_fail_1

workflows:
  ci:
    jobs:
      - preview-provision:
          context: app-hlidac-shopu
          filters:
            branches:
              ignore: master
      - provision:
          context: app-hlidac-shopu
          filters:
            branches:
              only: master
      - build-web-extension
      - build-website:
          context: org-global
