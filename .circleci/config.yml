version: 2.1
orbs:
  node: circleci/node@4.1.0
  slack: circleci/slack@4.0.1

jobs:
  build-website:
    executor:
      name: node/default
      tag: '14.13.1'
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: yarn
      - run:
          name: Build website
          command: yarn build:www.hlidacshopu.cz
      - slack/notify:
          event: fail
          template: basic_fail_1
      - persist_to_workspace:
          root: .
          paths: [ public ]

  build-web-extension:
    executor:
      name: node/default
      tag: '14.13.1'
    steps:
      - checkout
      - run:
          name: Install CLI tools
          command: |
            sudo apt-get update
            sudo apt-get install rename
      - node/install-packages:
          pkg-manager: yarn
      - run:
          name: Lint web extension
          command: |
            mkdir -p results
            yarn lint:extension
            yarn lint:extension -o json > results/lint.json
      - run:
          name: Build web extensions
          command: |
            yarn build:chrome
            yarn build:firefox
      - slack/notify:
          event: fail
          template: basic_fail_1
      - store_artifacts:
          path: ./results
      - store_artifacts:
          path: ./dist

workflows:
  ci:
    jobs:
      - build-web-extension
      - build-website:
          context: org-global
